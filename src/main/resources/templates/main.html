<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MXOF Pilot App - Accounts Information</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<h1>Hello <span th:text="${user.username}"></span></h1>

current user:
email: <span th:text="${user.email}"></span> <br>
useName: <span th:text="${user.username}"></span> <br>
<a th:href="@{/logout}">Logout</a>
<div>
    <button id="get_accounts">Get accounts</button>
    <div id="account_list">

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<script lang="javascript">
$(function(){
    $.ajaxSetup({
        "error": function (e) {
            alert(`error: code=${e.status}, fail msg: ${e.responseText}`);
            console.log(e);
        }
    });
    $('#get_accounts').click(function(){
        $.getJSON("/accounts", function(data) {
            const container = $('#account_list').empty().append('<h1>Account List:</h1>');
            $.each(data.Account, function(index, account) {
                let a = '';
                if(account.Account) {
                    a = `<br>
                    SchemeName: ${account.Account.schemeName}<br>
                    Identification: ${account.Account.Identification}<br>
                    Name:${account.Account.Name}`;
                }
                container.append(`
            <div>
                AccountId: ${account.accountId} <br>
                Currency: ${account.currency} <br>
                Nickname: ${account.nickname} ${a}<br>
                <button class="get_balances" account_id="${account.accountId}">Get Balances</button> <button class="get_transactions" account_id="${account.accountId}">Get Transactions</button>
                <div class="balances"></div>
                <div class="transactions"></div>
                <hr>
            </div>
            `);
            });
            $('.get_balances').click(function(){
                let balancesEle = $(this).siblings('.balances').empty().append('<h3>Balance List:</h3>');;
                let accountId =  $(this).attr('account_id');
                $.getJSON('/balances/account_id/'+ accountId, function(data){
                    if(Array.isArray(data)) {
                        $.each(data, function(i, it){
                            let zson = JSON.stringify(it, null, 2);
                            balancesEle.append(`<code>${zson}<code>`).append('<br>');
                        });
                        if(!data || data.length === 0) {
                            balancesEle.append(' Empty');
                        }
                    } else {
                        let zson = JSON.stringify(data, null, 2);
                        balancesEle.append(`<code>${zson}<code>`).append('<br>');
                    }
                });
            });
            $('.get_transactions').click(function(){
                let accountsEle = $(this).siblings('.transactions').empty().append('<h3>Transaction List:</h3>');
                let accountId =  $(this).attr('account_id');
                $.getJSON('/transactions/account_id/'+ accountId, function(data){
                    if(Array.isArray(data)) {
                        $.each(data, function(i, it){
                            let zson = JSON.stringify(it, null, 2);
                            accountsEle.append(`<code>${zson}<code>`).append('<br>');
                        });
                        if(!data || data.length === 0) {
                            accountsEle.append(' Empty');
                        }
                    } else {
                        let zson = JSON.stringify(data, null, 2);
                        accountsEle.append(`<code>${zson}<code>`).append('<br>');
                    }
                });
            });
        });
    });
})
</script>
</body>
</html>